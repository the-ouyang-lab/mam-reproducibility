library(Seurat)library(ggplot2)library(slingshot)library(monocle3)library(ggrepel)library(dplyr)library(RColorBrewer)library(destiny)library(ggpubr)library(stringr)setwd("~/Documents/nBox/eLife_MAM/Trajectory/")# Loading in objects ####SPP1seu <- readRDS("~/Documents/nBox/eLife_MAM/Objects/SPP1seu.rds")# Propensity Score ##### The function reads in a single cell experiment object, we must create an SCE object with the integrated assay, subsetting the cells of interest.# The object must have the disease status in the metadata ($disease)propensity.calc <-  function(trans,           dm,           Trans = c("SPP1+MAM-"),           receiver = c("Trans"),           out = c("SPP1+MAM+"),           p = .05) {    prob <- c()    disease <- c()        Trans_t <- dm@transitions / rowSums(dm@transitions)    int_c <- intersect(colnames(Trans_t), colnames(trans))    trans <- trans[, int_c]    Trans_t <- Trans_t[int_c,]    is_row <- rowSums(is.na(Trans_t)) == 0            for (d in c(unique(trans$disease))) {      is_d <- trans$disease == d            if (sum(trans$newclust %in% receiver & is_row & is_d) > 1) {        r <-          rowSums(Trans_t[trans$newclust %in% Trans &                            is_row &                            is_d, trans$newclust %in% receiver & is_row & is_d])      } else {        r <-          sum(Trans_t[trans$newclust %in% Trans &                        is_row &                        is_d, trans$newclust %in% receiver & is_row & is_d])      }            if (sum(trans$newclust %in% out & is_row & is_d) > 1) {        s <-          rowSums(Trans_t[trans$newclust %in% Trans &                            is_row & is_d, trans$newclust %in% out & is_row & is_d])      } else {        s <-          sum(Trans_t[trans$newclust %in% Trans &                        is_row & is_d, trans$newclust %in% out & is_row & is_d])      }                  q <- r + s      r <- r[q > p]      s <- s[q > p]      prob <- c(prob, s / (r + s))      disease <- c(disease, rep(d, length(s)))      cell_index <-        rownames(Trans_t)[trans$newclust %in% Trans &                            is_d & is_row][q > p]    }        to_plot <- data.frame("dis" = disease, "propensity" = prob)    return(list(to_plot))  }## Heart ############ Preprocessing ##### Rename the identities, find the MAMs and label themheart <- readRDS("../Objects/heart.rds")heart$disease <-  gsub("norm",       "Control",       str_split(colnames(heart), pattern = "-", simplify = T)[, 2])heart <-  RenameIdents(    heart,    "fcn1-6" = "FCN1+",    "fcn1-4_10" = "FCN1+",    "rnase-1" = "RNASE1+",    "spp1-2" = "SPP1+MAM-",    "spp1-rnase-9" = "SPP1+MAM-",    "0" = "Trans",    "3" = "Trans",    "5" = "Trans",    "7" = "Trans",    "8" = "Trans"  )heart <-  SetIdent(heart, cells = Cells(subset(SPP1seu, tissue == "heart" &                                         mam == "MAM")), value = "SPP1+MAM+")heart$newclust <- Idents(heart)# Create Single Cell Experiment Objectsce.heart <-  as.SingleCellExperiment(subset(heart, idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans")), assay = "integrated")# Run DiffusionMap function# dm.heart <-  DiffusionMap(sce.heart, verbose = T, k = round(0.1*ncol(sce.heart)), n_pcs = 50)# saveRDS(dm.heart,"dm_heart.RDS") # save to memory and save computational timedm.heart <- readRDS(file = "dm_heart.RDS")# Run Propensity Calculationheart.diff <-  propensity.calc(    trans = sce.heart,    dm = dm.heart,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )heart.diff <- heart.diff[[1]]heart.diff$organ <- "Heart"heart <- AddMetaData(heart, heart.diff)heart@meta.data <-  replace(heart@meta.data, is.na(heart@meta.data), 0)heart.diff$dis <-  factor(heart.diff$dis, levels = c("Control", "ICM", "DCM"))### UMAPS ####prop.heart.df <-  data.frame(    heart@reductions$umap@cell.embeddings,    clust = heart$newclust,    propensity = heart$propensity,    disease = heart$disease  )remove(heart, sce.heart)pdf(file = "slingshot_figures/heart_prop_umap.pdf",    width = 10,    height = 10)ggplot(prop.heart.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 0.5,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1)  ) +  theme_void() +  theme(legend.position = "bottom", strip.text = element_text(size = 30)) +  facet_wrap( ~ disease, ncol = 2) +  NoLegend()dev.off()### Violin Plot ####pdf(file = "slingshot_figures/heart_prop_vln.pdf",    width = 10,    height = 10)violin.heart <- ggplot(heart.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "white")  ) +  stat_compare_means(    comparisons = list(c("ICM", "Control"), c("DCM", "Control")),    method = "wilcox.test",    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()violin.heartdev.off()## Liver ####### Preprocessing ##### Rename the identities, find the MAMs and label themliver <- readRDS("../Objects/liver.rds")liver$disease <-  gsub("cirr", "Cirrhosis", gsub(    "norm",    "Control",    str_split(colnames(liver), pattern = "-", simplify = T)[, 2]  ))liver <-  RenameIdents(    liver,    "fcn1-2" = "FCN1+",    "rnase-1" = "RNASE1+",    "spp1-7" = "SPP1+MAM-",    "0" = "MARCO+",    "3_5" = "Trans",    "4" = "Trans",    "6" = "Trans"  )liver <-  SetIdent(liver, cells = Cells(subset(SPP1seu, tissue == "liver" &                                         mam == "MAM")), value = "SPP1+MAM+")liver$newclust <- Idents(liver)# Create Single Cell Experiment Objectsce.liver <-  as.SingleCellExperiment(subset(liver, idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans")), assay = "integrated")# Run DiffusionMap function# dm.liver <-  DiffusionMap(sce.liver, verbose = T, k = round(0.1*ncol(sce.liver)), n_pcs = 50)# saveRDS(dm.liver, "dm_liver.RDS")dm.liver <- readRDS("dm_liver.RDS")# Run Propensity Calculationliver.diff <-  propensity.calc(    trans = sce.liver,    dm = dm.liver,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )liver.diff <- liver.diff[[1]]liver.diff$organ <- "Liver"liver <- AddMetaData(liver, liver.diff)liver@meta.data <-  replace(liver@meta.data, is.na(liver@meta.data), 0)liver.diff$dis <-  factor(liver.diff$dis, levels = c("Control", "Cirrhosis", "NASH"))### UMAPS ####prop.liver.df <-  data.frame(    liver@reductions$umap@cell.embeddings,    clust = liver$newclust,    propensity = liver$propensity,    disease = liver$disease  )remove(liver, sce.liver)pdf(file = "slingshot_figures/liver_prop_umap.pdf",    width = 10,    height = 10)ggplot(prop.liver.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 1,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1)  ) +  theme_void() +  theme(legend.position = "bottom", strip.text = element_text(size = 30)) +  facet_wrap( ~ factor(disease, c("Control", "Cirrhosis", "NASH")), ncol = 2) +  NoLegend()# guides(color = guide_legend(override.aes = list(size = 5)))dev.off()### Violin Plot ####violin.liver <- ggplot(liver.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("Propensity to become SPP1+MAM+") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "black")  ) +  stat_compare_means(    label = "p.format",    comparisons = list(c("Cirrhosis", "Control"), c("NASH", "Control")),    method = "wilcox.test",    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()violin.liver## Lung ####### Preprocessing ##### Rename the identities, find the MAMs and label themlung <- readRDS("../Objects/lung.rds")lung$disease <-  gsub("SSC", "SSc", gsub(    "norm",    "Control",    gsub("SScILD","SSc",         str_split(colnames(lung), pattern = "-", simplify = T)[, 2]    )))lung <-  RenameIdents(    lung,    "0" = "Trans",    "1_15" = "Trans",    "10" = "Trans",    "11" = "Trans",    "14" = "Trans",    "16" = "Trans",    "3_12" = "Trans",    "4_8_13" = "FABP4+",    "6" = "Trans",    "9" = "Trans",    "fcn1-7" = "FCN1+",    "rnase-2" = "RNASE1+",    "spp1-rnase-5" = "SPP1+MAM-"  )lung <-  SetIdent(lung, cells = Cells(subset(SPP1seu, tissue == "lung" &                                        mam == "MAM")), value = "SPP1+MAM+")lung$newclust <- Idents(lung)# Create Single Cell Experiment ObjectDefaultAssay(lung) <- "integrated"lung.diet <-  subset(    DietSeurat(lung, assays = "integrated", dimreducs = "umap"),    idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans"),    subset = disease %in% c("Control", "IPF", "SSc")  )lung.diet <-  lung.diet[, sample(colnames(lung.diet), size = 25000, replace = F)]sce.lung <- as.SingleCellExperiment(lung.diet)#dm.lung <-  DiffusionMap(sce.lung, verbose = T, k = round(0.1*ncol(sce.lung)), n_pcs = 50)#saveRDS(dm.lung, "dm_lung.RDS")dm.lung <- readRDS("dm_lung.RDS")# Run Propensity Calculationlung.diff <-  propensity.calc(    trans = sce.lung,    dm = dm.lung,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )lung.diff <- lung.diff[[1]]lung.diet <- AddMetaData(lung.diet, lung.diff)lung.diet@meta.data <-  replace(lung.diet@meta.data, is.na(lung.diet@meta.data), 0)lung.diff$dis <-  factor(lung.diff$dis, levels = c("Control", "SSc", "IPF"))lung.diff$organ <- "Lung"### UMAPS ####prop.lung.df <-  data.frame(    lung.diet@reductions$umap@cell.embeddings,    clust = lung.diet$newclust,    propensity = lung.diet$propensity,    disease = lung.diet$disease  )remove(lung, lung.diet, sce.lung)pdf(file = "slingshot_figures/lung_prop_umap.pdf",    width = 10,    height = 10)ggplot(prop.lung.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 0.5,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1)  ) +  theme_void() +  theme(legend.position = "bottom", strip.text = element_text(size = 30)) +  facet_wrap( ~ factor(disease, c("Control", "IPF", "SSc")), ncol = 2) +  NoLegend()# guides(color = guide_legend(override.aes = list(size = 5)))dev.off()### Violin Plot ####violin.lung <- ggplot(lung.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "white")  ) +  stat_compare_means(    comparisons = list(c("SSc", "Control"), c("IPF", "Control")),    method = "wilcox.test",    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()## Skin ####### Preprocessing ##### Rename the identities, find the MAMs and label themskin <- readRDS("../Objects/skin.rds")skin$disease <-  gsub("norm",       "Control",       str_split(colnames(skin), pattern = "-", simplify = T)[, 2])skin <-  RenameIdents(    skin,    "0" = "Trans",    "3" = "Trans",    "fcn1-2" = "FCN1+",    "rnase-1" = "RNASE1+",    "spp1-4" = "SPP1+MAM-"  )DefaultAssay(skin) <- "RNA"skin <-  SetIdent(skin, cells = Cells(subset(SPP1seu, tissue == "skin" &                                        mam == "MAM")), value = "SPP1+MAM+")skin$newclust <- Idents(skin)# Create Single Cell Experiment Objectsce.skin <-  as.SingleCellExperiment(subset(skin, idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans")), assay = "integrated")# Run Propensity Calculation# dm.skin <- DiffusionMap(sce.skin, verbose = T, k = round(0.1 * ncol(sce.skin)), n_pcs = 50)# saveRDS(dm.skin, "dm_skin.RDS")dm.skin <- readRDS("dm_skin.RDS")skin.diff <-  propensity.calc(    trans = sce.skin,    dm = dm.skin,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )skin.diff <- skin.diff[[1]]skin.diff$organ <- "Skin"skin.diff$propensity <-  replace(skin.diff$propensity, is.na(skin.diff$propensity), 0)skin <- AddMetaData(skin, skin.diff)skin@meta.data <- replace(skin@meta.data, is.na(skin@meta.data), 0)skin.diff$dis <-  factor(skin.diff$dis, levels = c("Control", "Keloid", "SSc"))### UMAPS ####prop.skin.df <-  data.frame(    skin@reductions$umap@cell.embeddings,    clust = skin$newclust,    propensity = skin$propensity,    disease = skin$disease  )remove(skin, sce.skin)pdf(file = "slingshot_figures/skin_prop_umap.pdf",    width = 10,    height = 10)ggplot(prop.skin.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 1,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1)  ) +  theme_void() +  theme(legend.position = "bottom", strip.text = element_text(size = 30)) +  facet_wrap( ~ disease, ncol = 2) +  NoLegend()# guides(color = guide_legend(override.aes = list(size = 5)))dev.off()### Violin Plot ####violin.skin <- ggplot(skin.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "white")  ) +  stat_compare_means(    comparisons = list(c("Keloid", "Control"), c("SSc", "Control")),    method = "wilcox.test",    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()## Endo ####### Preprocessing ##### Rename the identities, find the MAMs and label themendo <- readRDS("../Objects/endo.rds")endo$disease <-  gsub("endo", "Endometriosis", gsub(    "norm",    "Control",    str_split(colnames(endo), pattern = "-", simplify = T)[, 2]  ))endo <-  RenameIdents(    endo,    "1_4" = "Trans",    "11" = "Trans",    "12" = "Trans",    "15" = "Trans",    "3" = "Trans",    "6" = "Trans",    "7" = "Trans",    "8_16" = "Trans",    "fcn1-0_14" = "FCN1+",    "fcn1-13" = "FCN1+",    "spp1-10" = "SPP1+MAM-",    "spp1-rnase-2_9" = "SPP1+MAM-",    "spp1-rnase-5" = "SPP1+MAM-"  )DefaultAssay(endo) <- "RNA"endo <-  SetIdent(endo, cells = Cells(subset(SPP1seu, tissue == "endo" &                                        mam == "MAM")), value = "SPP1+MAM+")endo$newclust <- Idents(endo)# Create Single Cell Experiment Objectsce.endo <-  as.SingleCellExperiment(subset(endo, idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans")), assay = "integrated")# dm.endo <-  DiffusionMap(sce.endo, verbose = T, k = round(0.1*ncol(sce.endo)), n_pcs = 50)# saveRDS(dm.endo, "dm_endo.RDS")dm.endo <- readRDS("dm_endo.RDS")# Run Propensity Calculationendo.diff <-  propensity.calc(    trans = sce.endo,    dm = dm.endo,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )endo.diff <- endo.diff[[1]]endo.diff$organ <- "Endometrium"endo <- AddMetaData(endo, endo.diff)endo@meta.data <- replace(endo@meta.data, is.na(endo@meta.data), 0)endo.diff$dis <-  factor(endo.diff$dis, levels = c("Control", "Endometriosis"))### UMAPS ####prop.endo.df <-  data.frame(    endo@reductions$umap@cell.embeddings,    clust = endo$newclust,    propensity = endo$propensity,    disease = endo$disease  )remove(endo, sce.endo)pdf(file = "slingshot_figures/endo_prop_umap.pdf",    width = 10,    height = 5)ggplot(prop.endo.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 1,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1),    name = "Propensity"  ) +  theme_void() +  theme(    legend.position = "bottom",    strip.text = element_text(size = 30),    legend.key.size = unit(2, "cm"),    legend.title = element_text(size = 30),    legend.text = element_text(size = 25)  ) +  facet_wrap( ~ disease, ncol = 2) + NoLegend()# guides(color = guide_legend(override.aes = list(size = 5)))dev.off()### Violin Plot ####violin.endo <- ggplot(endo.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "white")  ) +  stat_compare_means(    comparisons = list(c("Endometriosis", "Control"), c("Endometriosis", "Control")),    method = "wilcox.test",    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()## Kidney ####### Preprocessing ##### Rename the identities, find the MAMs and label themkidney <- readRDS("../Objects/kidney.rds")kidney$disease <-  gsub("norm",       "Control",       gsub("rej", "AKI",       str_split(colnames(kidney), pattern = "-", simplify = T)[, 2]))kidney <-  RenameIdents(    kidney,    "1_6" = "Trans",    "2" = "Trans",    "fcn1-0" = "FCN1+",    "spp1-3" = "SPP1+MAM-",    "spp1-5" = "SPP1+MAM-",    "rnase-4" = "RNASE1+"  )DefaultAssay(kidney) <- "RNA"kidney <-  SetIdent(kidney, cells = Cells(subset(SPP1seu, tissue == "kidney" &                                          mam == "MAM")), value = "SPP1+MAM+")kidney$newclust <- Idents(kidney)# Create Single Cell Experiment Objectsce.kidney <-  as.SingleCellExperiment(subset(    kidney,    idents = c("SPP1+MAM-", "SPP1+MAM+", "Trans"),    subset = disease %in% c("Control", "CKD", "AKI")  ), assay = "integrated")# dm.kidney <-  DiffusionMap(sce.kidney, verbose = T, k = round(0.1*ncol(sce.kidney)), n_pcs = 50)# saveRDS(dm.kidney, "dm_kidney.RDS")dm.kidney <- readRDS("dm_kidney.RDS")# Run Propensity Calculationkidney.diff <-  propensity.calc(    trans = sce.kidney,    dm = dm.kidney,    Trans = c("SPP1+MAM-"),    receiver = c("Trans"),    out = c("SPP1+MAM+"),    p = 0.05  )kidney.diff <- kidney.diff[[1]]kidney.diff$organ <- "Kidney"kidney <- AddMetaData(kidney, kidney.diff)kidney@meta.data <-  replace(kidney@meta.data, is.na(kidney@meta.data), 0)kidney.diff$dis <-  factor(kidney.diff$dis, levels = c("Control", "CKD", "AKI"))### UMAPS ####prop.kidney.df <-  data.frame(    kidney@reductions$umap@cell.embeddings,    clust = kidney$newclust,    propensity = kidney$propensity,    disease = kidney$disease  )remove(kidney, sce.kidney)pdf(file = "slingshot_figures/kidney_prop_umap.pdf",    width = 10,    height = 10)ggplot(prop.kidney.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(    aes(color = propensity),    alpha = 1,    size = 1,    position = position_jitter(width = 0.01)  ) +  scale_color_steps(    low = "lightgrey",    high = "firebrick4",    breaks = c(0, 0.05, 0.15, 0.25, 1),    limits = c(0, 1),    name = "Propensity"  ) +  theme_void() +  facet_wrap( ~ disease, ncol = 2) +  theme(legend.position = "bottom", strip.text = element_text(size = 35)) +  facet_wrap( ~ factor(disease, c("Control", "AKI", "CKD")), ncol = 2) +  NoLegend()dev.off()### Violin Plot ####violin.kidney <- ggplot(kidney.diff, aes(x = dis, y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  theme_classic(base_line_size = .5, base_size = 35) +  xlab("") +  ylab("") +  theme(    axis.text.x = element_text(angle = 45, vjust = 0.5),    axis.text.y = element_text(colour = "white")  ) +  stat_compare_means(    comparisons = list(c("CKD", "Control"), c("AKI", "Control")),    method = "wilcox.test",    method.args = list("alternative" = "greater"),    size = 10,    bracket.size = 0.1,    tip.length = 0,    step.increase = 0.15  ) +  NoLegend()# Combined Violin plots ##### liver.diff$dis <- gsub("Control", "Control_Liver", liver.diff$dis)# lung.diff$dis <- gsub("Control", "Control_Lung", lung.diff$dis)# heart.diff$dis <- gsub("Control", "Control_Heart", heart.diff$dis)# skin.diff$dis <- gsub("Control", "Control_Skin", skin.diff$dis)# endo.diff$dis <- gsub("Control", "Control_Endo", endo.diff$dis)# kidney.diff$dis <- gsub("Control", "Control_Kidney", kidney.diff$dis)comb.diff <-  do.call(rbind,          list(            liver.diff,            lung.diff,            heart.diff,            skin.diff,            endo.diff,            kidney.diff          ))comb.diff$organ <-  factor(comb.diff$organ,         levels = c("Liver", "Lung", "Heart", "Skin", "Endometrium", "Kidney"))comparisons <- list(  c('DCM', 'Control'),  c('ICM', 'Control'),  c('Cirrhosis', 'Control'),  c('NASH', 'Control'),  c('Endometriosis', 'Control'),  c('AKI', 'Control'),  c('CKD', 'Control'),  c('SSC', 'Control'),  c('Keloid', 'Control'),  c('IPF', 'Control'),  c('SSc', 'Control'))test <-  compare_means(    propensity ~ dis,    comb.diff,    method = "wilcox.test",    group.by = "organ",    ref.group = "Control"  )test$group1 <- paste0(test$group1, '.', test$organ)test$group2 <- paste0(test$group2, '.', test$organ)pdf(file = "slingshot_figures/prop_violin.pdf",    width = 27,    height = 15)ggplot(comb.diff, aes(x = interaction(dis, organ), y = propensity)) +  geom_violin(    adjust = 2.5,    width = 0.8,    scale = 'width',    aes(fill = ifelse(dis == "Control", "salmon", "purple3"))  ) +  scale_fill_identity() +  geom_jitter(    height = 0,    width = 0.2,    color = "black",    size = 0.5  ) +  ylim(0, 1.2) +  stat_summary(    fun.y = median,    geom = "point",    size = 20,    colour = "white",    shape = 95  ) +  facet_wrap(    ~ organ,    nrow = 1,    strip.position = "top",    scale = "free_x",    drop = T,    shrink = F,    # labeller = labeller(dis = c("Control.Liver"= "Control"))  ) +  stat_pvalue_manual(    data = test,    y.position = 1.05,    # bracket.nudge.y = -1,    size = 8,    step.group.by = "organ",    bracket.size = 0.1,    step.increase = 0.075,    tip.length = 0  ) +  theme_classic(base_line_size = .5, base_size = 30) +  xlab("") +  ylab("Score of propensity to become SPP1+MAM+") +  theme(    axis.text.x = element_text(      angle = 45,      vjust = 0.9,      hjust = 1    ),    # axis.text.y = element_text(colour = "white"),    panel.grid.major = element_blank(),    panel.grid.minor = element_blank(),    strip.background = element_blank(),    strip.text = element_text(size = 35)  ) +  NoLegend()dev.off()