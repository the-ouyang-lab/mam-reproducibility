library(Seurat)library(ggplot2)library(slingshot)library(monocle3)library(ggrepel)library(dplyr)library(RColorBrewer)library(destiny)library(ggpubr)library(stringr)library(SeuratWrappers)library(SeuratDisk)setwd("~/Documents/nBox/eLife_MAM/Trajectory/")color.pals <- c(  "FCN1+" = "dodgerblue",  "FCN1+LST1+" = "dodgerblue",  "LST1+" = "lightgrey",  "Trans" = "lightgrey",  "RNASE1+" = "olivedrab",  "RNASE1+LYVE1+" = "olivedrab",  "SPP1+RNASE1+LYVE1+" = "olivedrab",  "SPP1+MAM-" = "firebrick",  "SPP1+MAM+" = "black",  "FABP4+" = "goldenrod",  "MARCO+" = "darkorange",  "LYVE1+" = "darkorange",  "LYVE1+MARCO+" = "darkorange")# Loading in objects ####SPP1seu <- readRDS("~/Documents/nBox/eLife_MAM/Objects/SPP1seu.rds")# Heart #####heart <- readRDS("../Objects/heart.rds")heart <- RenameIdents(  heart,  "fcn1-6" = "FCN1+LST1+",  "fcn1-4_10" = "FCN1+",  "rnase-1" = "RNASE1+",  "spp1-2" = "SPP1+MAM-",  "spp1-rnase-9" = "SPP1+MAM-",  "0" = "Trans",  "3" = "LYVE1+",  "5" = "Trans",  "7" = "Trans",  "8" = "Trans")heart <-  SetIdent(heart, cells = Cells(subset(SPP1seu, tissue == "heart" &                                         mam == "MAM")), value = "SPP1+MAM+")heart$newclust <- Idents(heart)dimred.heart <- heart@reductions$umap@cell.embeddingsclustering.heart <- heart$clustheart.df <- data.frame(dimred.heart, clust = heart$newclust)center_df.heart <- heart.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))cds.heart <- as.cell_data_set(heart, assay = "integrated")recreate.partitions <- c(rep(1, length(cds.heart@colData@rownames)))names(recreate.partitions) <- cds.heart@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.heart@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.heart@clusters@listData[["UMAP"]][["clusters"]] <- heart$clustcds.heart@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  heart@reductions$umap@cell.embeddingscds.heart <- learn_graph(cds.heart, use_partition = F)cds.heart <-  order_cells(cds.heart,              reduction_method = "UMAP",              root_cells = colnames(cds.heart[, clusters(cds.heart) == "fcn1-4_10"]))pdf(file = "monocle_figures/heart_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.heart,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves = T,  trajectory_graph_color = "purple",  label_principal_points = F,  trajectory_graph_segment_size = 2,  alpha = 1,  group_cells_by = "cluster",  show_trajectory_graph = T,  cell_size = 0.8,  label_cell_groups = F,  labels_per_group = 1,  graph_label_size = 5)  +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) +  NoLegend() +   theme_void()dev.off()# Liver ##### Rename the identities, find the MAMs and label themliver <- readRDS("../Objects/liver.rds")liver <- RenameIdents(  liver,  "fcn1-2" = "FCN1+",  "rnase-1" = "RNASE1+",  "spp1-7" = "SPP1+MAM-",  "0" = "LYVE1+MARCO+",  "3_5" = "Trans",  "4" = "LST1+",  "6" = "Trans")liver <-  SetIdent(liver, cells = Cells(subset(SPP1seu, tissue == "liver" &                                         mam == "MAM")), value = "SPP1+MAM+")liver$newclust <- Idents(liver)cds.liver <- as.cell_data_set(liver)recreate.partitions <- c(rep(1, length(cds.liver@colData@rownames)))names(recreate.partitions) <- cds.liver@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.liver@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.liver@clusters@listData[["UMAP"]][["clusters"]] <- liver$clustcds.liver@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  liver@reductions$umap@cell.embeddingscds.liver <- learn_graph(cds.liver, use_partition = F)cds.liver <-  order_cells(cds.liver,              reduction_method = "UMAP",              root_cells = colnames(cds.liver[, clusters(cds.liver) == "fcn1-2"]))pdf(file = "monocle_figures/liver_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.liver,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves = T,  trajectory_graph_color = "purple",  alpha = 1,  cell_size = 0.8,  label_cell_groups = F) +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) + NoLegend() + theme_void()dev.off()# Lung #####lung <- readRDS("../Objects/lung.rds")lung <- RenameIdents(  lung,  "0" = "Trans",  "1_15" = "Trans",  "10" = "Trans",  "11" = "Trans",  "14" = "Trans",  "16" = "Trans",  "3_12" = "Trans",  "4_8_13" = "FABP4+",  "6" = "Trans",  "9" = "Trans",  "fcn1-7" = "FCN1+",  "rnase-2" = "RNASE1+",  "spp1-rnase-5" = "SPP1+MAM-")lung <-  SetIdent(lung, cells = Cells(subset(SPP1seu, tissue == "lung" &                                        mam == "MAM")), value = "SPP1+MAM+")lung$newclust <- Idents(lung)lung.diet <-  subset(DietSeurat(lung, assays = "integrated", dimreducs = "umap"))cds.lung <- as.cell_data_set(lung.diet)recreate.partitions <- c(rep(1, length(cds.lung@colData@rownames)))names(recreate.partitions) <- cds.lung@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.lung@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.lung@clusters@listData[["UMAP"]][["clusters"]] <- lung$clustcds.lung@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  lung.diet@reductions$umap@cell.embeddingscds.lung <- learn_graph(cds.lung, use_partition = F)cds.lung <-  order_cells(cds.lung,              reduction_method = "UMAP",              root_cells = colnames(cds.lung[, clusters(cds.lung) == "fcn1-7"]))pdf(file = "monocle_figures/lung_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.lung,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves =F,  trajectory_graph_color = "purple",  alpha = 1,  cell_size = 0.8,  label_cell_groups = F) +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) + NoLegend() + theme_void()dev.off()# Skin #####skin <- readRDS("../Objects/skin.rds")skin <- RenameIdents(  skin,  "0" = "Trans",  "3" = "LST1+",  "fcn1-2" = "FCN1+",  "rnase-1" = "RNASE1+LYVE1+",  "spp1-4" = "SPP1+MAM-")skin <-  SetIdent(skin, cells = Cells(subset(SPP1seu, tissue == "skin" &                                        mam == "MAM")), value = "SPP1+MAM+")skin$newclust <- Idents(skin)cds.skin <- as.cell_data_set(skin)recreate.partitions <- c(rep(1, length(cds.skin@colData@rownames)))names(recreate.partitions) <- cds.skin@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.skin@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.skin@clusters@listData[["UMAP"]][["clusters"]] <- skin$clustcds.skin@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  skin@reductions$umap@cell.embeddingscds.skin <- learn_graph(cds.skin, use_partition = F)cds.skin <-  order_cells(cds.skin,              reduction_method = "UMAP",              root_cells = colnames(cds.skin[, clusters(cds.skin) == "fcn1-2"]))pdf(file = "monocle_figures/skin_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.skin,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves = F,  trajectory_graph_color = "purple",  alpha = 1,  cell_size = 1.5,  label_cell_groups = F) +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) + NoLegend() + theme_void()dev.off()# Endometrium #####endo <- readRDS("../Objects/endo.rds")endo <- RenameIdents(  endo,  "1_4" = "Trans",  "11" = "Trans",  "12" = "Trans",  "15" = "Trans",  "3" = "Trans",  "6" = "Trans",  "7" = "Trans",  "8_16" = "LST1+",  "fcn1-0_14" = "FCN1+",  "fcn1-13" = "FCN1+LST1+",  "spp1-10" = "SPP1+MAM-",  "spp1-rnase-2_9" = "SPP1+RNASE1+LYVE1+",  "spp1-rnase-5" = "SPP1+MAM-")endo <-  SetIdent(endo, cells = Cells(subset(SPP1seu, tissue == "endo" &                                        mam == "MAM")), value = "SPP1+MAM+")endo$newclust <- Idents(endo)cds.endo <- as.cell_data_set(endo)recreate.partitions <- c(rep(1, length(cds.endo@colData@rownames)))names(recreate.partitions) <- cds.endo@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.endo@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.endo@clusters@listData[["UMAP"]][["clusters"]] <- endo$clustcds.endo@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  endo@reductions$umap@cell.embeddingscds.endo <- learn_graph(cds.endo, use_partition = F)cds.endo <-  order_cells(cds.endo,              reduction_method = "UMAP",              root_cells = colnames(cds.endo[, clusters(cds.endo) == "fcn1-0_14"]))pdf(file = "monocle_figures/endo_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.endo,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves = F,  trajectory_graph_color = "purple",  alpha = 1,  cell_size = 1.2,  label_cell_groups = F) +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) + NoLegend() + theme_void()dev.off()# Kidney #####kidney <- readRDS("../Objects/kidney.rds")kidney <- RenameIdents(  kidney,  "1_6" = "Trans",  "2" = "LST1+",  "fcn1-0" = "FCN1+",  "spp1-3" = "SPP1+MAM-",  "spp1-5" = "SPP1+MAM-",  "rnase-4" = "RNASE1+")kidney <-  SetIdent(kidney, cells = Cells(subset(SPP1seu, tissue == "kidney" &                                          mam == "MAM")), value = "SPP1+MAM+")kidney$newclust <- Idents(kidney)cds.kidney <- as.cell_data_set(kidney)recreate.partitions <-  c(rep(1, length(cds.kidney@colData@rownames)))names(recreate.partitions) <- cds.kidney@colData@rownamesrecreate.partitions <- as.factor(recreate.partitions)cds.kidney@clusters@listData[["UMAP"]][["partitions"]] <-  recreate.partitionscds.kidney@clusters@listData[["UMAP"]][["clusters"]] <- kidney$clustcds.kidney@int_colData@listData[["reducedDims"]]@listData[["UMAP"]] <-  kidney@reductions$umap@cell.embeddingscds.kidney <- learn_graph(cds.kidney, use_partition = F)cds.kidney <-  order_cells(cds.kidney,              reduction_method = "UMAP",              root_cells = colnames(cds.kidney[, clusters(cds.kidney) == "fcn1-0"]))pdf(file = "monocle_figures/kidney_umap_monocle.pdf",    width = 12,    height = 10)plot_cells(  cds.kidney,  color_cells_by = "newclust",  label_groups_by_cluster = F,  label_branch_points = F,  label_roots = F,  label_leaves = F,  trajectory_graph_color = "purple",  alpha = 1,  cell_size = 1.2,  label_cell_groups = F) +  scale_color_manual(values = color.pals) +  guides(color = guide_legend(override.aes = list(size = 5))) + NoLegend() + theme_void()dev.off()