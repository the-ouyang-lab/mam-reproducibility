library(Seurat)library(ggplot2)library(slingshot)library(monocle3)library(ggrepel)library(dplyr)library(RColorBrewer)library(ggpubr)library(stringr)setwd("~/Documents/nBox/eLife_MAM/Trajectory/")# Loading in objects ####SPP1seu <- readRDS("~/Documents/nBox/eLife_MAM/Objects/SPP1seu.rds")SPP1seu$status = data.table::tstrsplit(colnames(SPP1seu), "-")[[2]]SPP1seu@meta.data[SPP1seu$status == "SScILD", "status"] = "SSC"SPP1seu@meta.data[SPP1seu$status == "rej", "status"] = "AKI"# Slingshot ####set.seed(44)clustCol <- brewer.pal(7, "Set2")color.pals <- c(  "FCN1+" = "dodgerblue",  "FCN1+LST1+" = "dodgerblue",  "LST1+" = "lightgrey",  "Trans" = "lightgrey",  "RNASE1+" = "olivedrab",  "RNASE1+LYVE1+" = "olivedrab",  "SPP1+RNASE1+LYVE1+" = "olivedrab",  "SPP1+MAM-" = "firebrick",  "SPP1+MAM+" = "black",  "FABP4+" = "goldenrod",  "MARCO+" = "darkorange",  "LYVE1+" = "darkorange",  "LYVE1+MARCO+" = "darkorange")## Heart ####heart <- readRDS("../Objects/heart.rds")heart$disease <-  gsub("norm",       "Control",       str_split(colnames(heart), pattern = "-", simplify = T)[, 2])heart <- RenameIdents(  heart,  "fcn1-6" = "FCN1+LST1+",  "fcn1-4_10" = "FCN1+",  "rnase-1" = "RNASE1+",  "spp1-2" = "SPP1+MAM-",  "spp1-rnase-9" = "SPP1+MAM-",  "0" = "Trans",  "3" = "LYVE1+",  "5" = "Trans",  "7" = "Trans",  "8" = "Trans")heart <-  SetIdent(heart, cells = Cells(subset(SPP1seu, tissue == "heart" &                                         mam == "MAM")), value = "SPP1+MAM+")heart$newclust <- Idents(heart)dimred.heart <- heart@reductions$umap@cell.embeddingsclustering.heart <- heart$clustheart.df <- data.frame(dimred.heart, clust = heart$newclust)center_df.heart <- heart.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.heart <- center_df.heart[c(1, 3),]s.out.heart <-  slingshot(data = dimred.heart,            clusterLabels = clustering.heart,            start.clus = "fcn1-4_10") curves.heart <- slingCurves(s.out.heart, as.df = TRUE)# trimming some curves graphically to show the true trajectoriescurves.col.heart <-  curves.heart[-c(255:300, 115:150, 430:450, 1:5),] %>% arrange(Order) pdf(file = "slingshot_figures/heart_umap.pdf",    width = 10,    height = 10)ggplot(heart.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 0.5,) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.heart %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.heart$Lineage == 2, 3, 1),    lineend = "round",    color = ifelse(curves.col.heart$Lineage == 2, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.heart,    aes(label = clust),    size = 10,    nudge_x = -1.3,    nudge_y = -1,    alpha = 1,    min.segment.length = 10  ) +  NoLegend()dev.off()## Liver ####liver <- readRDS("../Objects/liver.rds")liver$disease <-  gsub("cirr", "Cirrhosis", gsub(    "norm",    "Control",    str_split(colnames(liver), pattern = "-", simplify = T)[, 2]  ))liver <- RenameIdents(  liver,  "fcn1-2" = "FCN1+",  "rnase-1" = "RNASE1+",  "spp1-7" = "SPP1+MAM-",  "0" = "LYVE1+MARCO+",  "3_5" = "Trans",  "4" = "LST1+",  "6" = "Trans")liver <-  SetIdent(liver, cells = Cells(subset(SPP1seu, tissue == "liver" &                                         mam == "MAM")), value = "SPP1+MAM+")liver$newclust <- Idents(liver)dimred.liver <- liver@reductions$umap@cell.embeddingsclustering.liver <- liver$clustliver.df <- data.frame(dimred.liver, clust = liver$newclust)center_df.liver <- liver.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.liver <- center_df.liver[c(1, 2),]s.out.liver <-  slingshot(data = dimred.liver,            clusterLabels = clustering.liver,            start.clus = "fcn1-2")curves.liver <- slingCurves(s.out.liver, as.df = TRUE)mst.liver <- slingMST(s.out.liver, as.df = TRUE)mst.order.liver <- mst.liver %>% arrange(Order)curves.col.liver <-  curves.liver[-c(130:150, 260:300, 400:450, 590:600),] %>% arrange(Order)pdf(file = "slingshot_figures/liver_umap.pdf",    width = 10,    height = 10)ggplot(liver.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 1,) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.liver %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.liver$Lineage == 2, 3, 1),    lineend = "round",    color = ifelse(curves.col.liver$Lineage == 2, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.liver,    mapping = aes(x = UMAP_1, y = UMAP_2, label = clust),    size = 10  ) +  NoLegend()dev.off()## Lung ####lung <- readRDS("../Objects/lung.rds")lung$disease <-  gsub("SSC", "SSc", gsub(    "norm",    "Control",    gsub("SScILD","SSc",    str_split(colnames(lung), pattern = "-", simplify = T)[, 2]  )))lung <- RenameIdents(  lung,  "0" = "Trans",  "1_15" = "Trans",  "10" = "Trans",  "11" = "Trans",  "14" = "Trans",  "16" = "Trans",  "3_12" = "Trans",  "4_8_13" = "FABP4+",  "6" = "Trans",  "9" = "Trans",  "fcn1-7" = "FCN1+",  "rnase-2" = "RNASE1+",  "spp1-rnase-5" = "SPP1+MAM-")lung <-  SetIdent(lung, cells = Cells(subset(SPP1seu, tissue == "lung" &                                        mam == "MAM")), value = "SPP1+MAM+")lung.diet <- DietSeurat(lung, dimreducs = "umap", assays = "integrated")lung.diet <- subset(lung.diet, disease %in% c("Control", "SSc", "IPF"))remove(lung)lung.diet$newclust <- Idents(lung.diet)# lung.diet <- subset(lung.diet, disease %in% c("Control", "SSc", "IPF"))dimred.lung.diet <- lung.diet@reductions$umap@cell.embeddingsclustering.lung.diet <- lung.diet$clustlung.diet.df <- data.frame(dimred.lung.diet, clust = lung.diet$newclust)center_df.lung.diet <- lung.diet.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.lung.diet <- center_df.lung.diet[c(1, 4),]s.out.lung.diet <-  slingshot(data = dimred.lung.diet,            clusterLabels = lung.diet$clust,            start.clus = "fcn1-7")curves.lung.diet <- slingCurves(s.out.lung.diet, as.df = TRUE)mst.lung.diet <- slingMST(s.out.lung.diet, as.df = TRUE)mst.order.lung.diet <- mst.lung.diet %>% arrange(Order)curves.col.lung.diet <-  curves.lung.diet[-c(130:150, 230:300, 430:450, 550:600, 710:750),] %>% arrange(Order)pdf(file = "slingshot_figures/lung_umap.pdf",    width = 10,    height = 10)ggplot(lung.diet.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 0.5, ) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.lung.diet %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.lung.diet$Lineage == 1, 3, 1),    lineend = "round",    color = ifelse(curves.col.lung.diet$Lineage == 1, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.lung.diet,    nudge_y = -2,    min.segment.length = 10,    mapping = aes(x = UMAP_1, y = UMAP_2, label = clust),    size = 10  ) +  NoLegend()dev.off()## Skin #####skin <- readRDS("../Objects/skin.rds")skin$disease <-  gsub("norm",       "Control",       str_split(colnames(skin), pattern = "-", simplify = T)[, 2])skin <- RenameIdents(  skin,  "0" = "Trans",  "3" = "LST1+",  "fcn1-2" = "FCN1+",  "rnase-1" = "RNASE1+LYVE1+",  "spp1-4" = "SPP1+MAM-")skin <-  SetIdent(skin, cells = Cells(subset(SPP1seu, tissue == "skin" &                                        mam == "MAM")), value = "SPP1+MAM+")skin$newclust <- Idents(skin)# DimPlot(liver,cells.highlight = Cells(subset(SPP1seu, tissue == "liver" & mam == "MAM")))dimred.skin <- skin@reductions$umap@cell.embeddingsclustering.skin <- skin$newclustskin.df <- data.frame(dimred.skin, clust = clustering.skin)center_df.skin <- skin.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.skin <- center_df.skin[c(1, 4),]s.out.skin <-  slingshot(data = dimred.skin,            clusterLabels = skin$clust,            start.clus = "fcn1-2")curves.skin <- slingCurves(s.out.skin, as.df = TRUE)mst.skin <- slingMST(s.out.skin, as.df = TRUE)mst.order.skin <- mst.skin %>% arrange(Order)curves.col.skin <- curves.skin[-c(115:150),] %>% arrange(Order)pdf(file = "slingshot_figures/skin_umap.pdf",    width = 10,    height = 10)ggplot(skin.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 2,) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.skin %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.skin$Lineage == 2, 3, 1),    lineend = "round",    color = ifelse(curves.col.skin$Lineage == 2, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.skin,    aes(label = clust),    size = 10,    nudge_x = -2.3,    nudge_y = 0.5,    # alpha = 0.7,    min.segment.length = 10  ) +  NoLegend()dev.off()## Endometrium ####endo <- readRDS("../Objects/endo.rds")endo$disease <-  gsub("endo", "Endometriosis", gsub(    "norm",    "Control",    str_split(colnames(endo), pattern = "-", simplify = T)[, 2]  ))endo <- RenameIdents(  endo,  "1_4" = "Trans",  "11" = "Trans",  "12" = "Trans",  "15" = "Trans",  "3" = "Trans",  "6" = "Trans",  "7" = "Trans",  "8_16" = "LST1+",  "fcn1-0_14" = "FCN1+",  "fcn1-13" = "FCN1+LST1+",  "spp1-10" = "SPP1+MAM-",  "spp1-rnase-2_9" = "SPP1+RNASE1+LYVE1+",  "spp1-rnase-5" = "SPP1+MAM-")endo <-  SetIdent(endo, cells = Cells(subset(SPP1seu, tissue == "endo" &                                        mam == "MAM")), value = "SPP1+MAM+")endo$newclust <- Idents(endo)dimred.endo <- endo@reductions$umap@cell.embeddingsclustering.endo <- endo$newclustendo.df <- data.frame(dimred.endo, clust = clustering.endo)center_df.endo <- endo.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.endo <- center_df.endo[c(1, 4),]s.out.endo <-  slingshot(data = dimred.endo,            clusterLabels = endo$clust,            start.clus = "fcn1-0_14")curves.endo <- slingCurves(s.out.endo, as.df = TRUE)mst.endo <- slingMST(s.out.endo, as.df = TRUE)mst.order.endo <- mst.endo %>% arrange(Order)curves.col.endo <-  curves.endo[-c(140:150, 260:300, 430:450, 595:600, 730:750, 895:900),] %>% arrange(Order)pdf(file = "slingshot_figures/endo_umap.pdf",    width = 10,    height = 10)ggplot(endo.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 1.5,) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.endo %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.endo$Lineage == 2, 3, 1),    lineend = "round",    color = ifelse(curves.col.endo$Lineage == 2, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.endo,    aes(label = clust),    size = 10,    nudge_x = -1.3,    nudge_y = -1,    # alpha = 0.8,    min.segment.length = 10  ) +  NoLegend()dev.off()## Kidney ####kidney <- readRDS("../Objects/kidney.rds")kidney$disease <-  gsub("norm",       "Control",       gsub("rej", "AKI",            str_split(colnames(kidney), pattern = "-", simplify = T)[, 2]))kidney <- RenameIdents(  kidney,  "1_6" = "Trans",  "2" = "LST1+",  "fcn1-0" = "FCN1+",  "spp1-3" = "SPP1+MAM-",  "spp1-5" = "SPP1+MAM-",  "rnase-4" = "RNASE1+")kidney <-  SetIdent(kidney, cells = Cells(subset(SPP1seu, tissue == "kidney" &                                          mam == "MAM")), value = "SPP1+MAM+")kidney$newclust <- Idents(kidney)dimred.kidney <- kidney@reductions$umap@cell.embeddingsclustering.kidney <- kidney$newclustkidney.df <- data.frame(dimred.kidney, clust = kidney$newclust)center_df.kidney <- kidney.df %>%  group_by(clust) %>%  summarize(UMAP_1 = mean(UMAP_1),            UMAP_2 = mean(UMAP_2))center_df.kidney <- center_df.kidney[c(1, 4),]s.out.kidney <-  slingshot(data = dimred.kidney,            clusterLabels = kidney$clust,            start.clus = "fcn1-0")curves.kidney <- slingCurves(s.out.kidney, as.df = TRUE)mst.kidney <- slingMST(s.out.kidney, as.df = TRUE)mst.order.kidney <- mst.kidney %>% arrange(Order)curves.col.kidney <-  curves.kidney[-c(1:30, 145:150, 151:185, 280:300, 301:340, 430:450),] %>% arrange(Order)pdf(file = "slingshot_figures/kidney_umap.pdf",    width = 10,    height = 10)ggplot(kidney.df, aes(x = UMAP_1, y = UMAP_2)) +  geom_point(aes(color = clust), alpha = 1, size = 1.5,) +  scale_color_manual(values = color.pals) +  theme_void(base_size = 30) +  guides(color = guide_legend(override.aes = list(size = 10))) +  geom_path(    data = curves.col.kidney %>% arrange(Order),    aes(group = Lineage),    size = ifelse(curves.col.kidney$Lineage == 1, 3, 1),    lineend = "round",    color = ifelse(curves.col.kidney$Lineage == 1, "black", "#5db7e3"),  ) +  geom_text_repel(    data = center_df.kidney,    aes(label = clust),    size = 10,    nudge_x = -2.3,    nudge_y = 0.5,    # alpha = 0.7,    min.segment.length = 10  ) +  NoLegend()dev.off()